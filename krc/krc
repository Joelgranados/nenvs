#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-3.0-only


PWD=$(pwd)
ENVS_GIT_REPO="github:Joelgranados/nix_envs"
BASENAME="$(basename "${BASH_SOURCE[0]}")"
USAGE="
Usage: ${BASENAME} [OPTIONS] <HOST> -- <COMMAND>

  Execute <COMMAND> in <HOST> through ssh connection.
  A mutagen session for PWD must exist.

HOST      Name of ssh-able host
COMMAND   Command to append

OPTIONS:
  -x, --cross-compile <ARCH>  Setup a cross-compilation environment for ARCH
                              just before executing <COMMAND>. Architecture
                              strings that work for Linux's ARCH argument should
                              work here.
  -e, --env <ENV>             Environment name under ${ENVS_GIT_REPO} to use
                              for the command. Valid values are _kerne and _qemu.
                              _kernel by default.
  -v, --verbose               Increase verbosity

"

_usage() {
    if [[ $2 -ne 0 ]]; then
        echo "$1" >&2
        exit "$2"
    fi
    echo "$1"
    exit 0
}

add_xcompile_cmds()
{
  local arch="$1"
  if [[ -v VERBOSE ]]; then
    echo "toolchain_ctl arch_wget ${arch} && toolchain_ctl arch_env ${arch}"
  fi
}

get_krc_opts()
{
  local short="x:e:v:h"
  local long="cross-compile:env:verbose:help"
  local active_env="_kernel"

  if ! tmp=$(getopt -o "$short" --long "$long" -n "$BASENAME" -- "$@"); then
    exit 1
  fi
  eval set -- "$tmp"
  unset tmp

  while true; do
    case "$1" in
      '-x' | '--cross-compile' )
        xcomp_arch=$2; shift 2
        ;;

      '-e' | '--env' )
        ENV_URL="${ENVS_GIT_REPO}\?dir=$2"; shift 2
        ;;

      '-h' | '--help' )
        _usage "${USAGE}" 0
        ;;

      '-v' | '--verbose' )
        VERBOSE=1; shift 2
        ;;

      '--' )
        shift 1; break
        ;;

      * )
        _usage "${USAGE}" 1
        ;;

    esac
  done

  shift $((OPTIND -1))
  # Make sure args are: "$@ = HOST COMMAND"
  if [ $# -lt 2 ]; then
    echo "Error: You are missing an argument"
    _usage "${USAGE}" 1
  fi

  HOST=$1; shift 1;

  # Update args after filtering out [OPTIONS]
  cmd_args="$@"

  if [[ -v xcomp_arch ]]; then
    cmd_args="$(add_xcompile_cmds ${xcomp_arch}) && ${cmd_args}"
  fi

  if [[ ! -v ENV_URL ]]; then
    ENV_URL="${ENVS_GIT_REPO}\?dir=_kernel"
  fi

  MUT_SESS_NAME="$(pwd | sed "s./..g")${HOST}"
}

mutagen_sync()
{
  local sess=$1
  local cmd="mutagen sync resume ${sess} \
    && mutagen sync flush ${sess} \
    && mutagen sync pause ${sess}"

  if [[ -v VERBOSE ]]; then
    echo ${cmd}
  fi
  eval ${cmd}
  if [ $? != 0 ]; then
    _usage "${USAGE}" 1
  fi
}

get_krc_opts "$@"

mutagen_sync ${MUT_SESS_NAME}

ssh ${HOST} << EOF
# Adjust PATH for non-login shells that connect to non-nix hosts
# with nix packages installed
if ! echo \$PATH | grep 'nix.profile' > /dev/null ; then
  PATH="~/.nix-profile/bin:/nix/var/nix/profiles/default/bin:\$PATH"
fi

cd ${PWD} && nix develop ${ENV_URL} --command bash -c "${cmd_args}"
EOF

mutagen_sync ${MUT_SESS_NAME}

